generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Category {
  id                    String                 @id @default(uuid())
  name                  String
  type                  CategoryType
  color                 String?
  icon                  String?
  userId                String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  position              Int?
  budgets               Budget[]
  user                  User?                  @relation(fields: [userId], references: [id])
  recurringTransactions RecurringTransaction[]
  subCategories         SubCategory[]
  transactions          Transaction[]
  investments           Investment[]

  @@index([userId])
  @@index([userId, position])
}

model SubCategory {
  id           String        @id @default(uuid())
  name         String
  color        String?
  icon         String?
  userId       String?
  categoryId   String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  category     Category      @relation(fields: [categoryId], references: [id])
  user         User?         @relation(fields: [userId], references: [id])
  transactions Transaction[]
  investments  Investment[]

  @@index([categoryId, userId])
}

model BankAccount {
  id                    String                 @id @default(uuid())
  name                  String
  type                  AccountType
  currency              Currency
  isActive              Boolean                @default(true)
  balance               Decimal                @default(0.0) @db.Decimal(65, 4)
  ifscCode              String?
  branch                String?
  bankId                String?
  bankAccount           String?
  isPrimary             Boolean                @default(false)
  userId                String
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  accountBalances       AccountBalance[]
  user                  User                   @relation(fields: [userId], references: [id])
  recurringTransactions RecurringTransaction[]
  transactions          Transaction[]

  @@index([userId])
}

model Transaction {
  id                     String                @id @default(uuid())
  amount                 Decimal               @db.Decimal(65, 4)
  currency               Currency
  type                   TransactionType
  status                 TransactionStatus     @default(PENDING)
  date                   DateTime
  description            String?
  comments               String?
  isActive               Boolean               @default(true)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  userId                 String
  bankAccountId          String
  categoryId             String?
  subCategoryId          String?
  recurringTransactionId String?
  paymentMethod          PaymentMethod?
  externalId             String?
  budgetId               String?
  bankAccount            BankAccount           @relation(fields: [bankAccountId], references: [id])
  budget                 Budget?               @relation(fields: [budgetId], references: [id])
  category               Category?             @relation(fields: [categoryId], references: [id])
  recurringTransaction   RecurringTransaction? @relation(fields: [recurringTransactionId], references: [id])
  subCategory            SubCategory?          @relation(fields: [subCategoryId], references: [id])
  user                   User                  @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([bankAccountId])
  @@index([categoryId])
  @@index([date])
}

model AccountBalance {
  id              String      @id @default(uuid())
  bankAccountId   String
  date            DateTime
  totalDeposit    Decimal     @default(0.0) @db.Decimal(65, 4)
  totalWithdrawal Decimal     @default(0.0) @db.Decimal(65, 4)
  currentBalance  Decimal     @db.Decimal(65, 4)
  bankId          String?
  bankAccounts    String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  bankAccount     BankAccount @relation(fields: [bankAccountId], references: [id])

  @@index([bankAccountId, date])
}

model Budget {
  id               String        @id @default(uuid())
  amount           Decimal       @db.Decimal(65, 4)
  month            Int?
  description      String?
  totalDeposits    Decimal       @default(0.0) @db.Decimal(65, 4)
  totalWithdrawals Decimal       @default(0.0) @db.Decimal(65, 4)
  userId           String
  categoryId       String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  alertThreshold   Int           @default(80)
  isActive         Boolean       @default(true)
  lastAlertSent    DateTime?
  year             Int?
  category         Category?     @relation(fields: [categoryId], references: [id])
  user             User          @relation(fields: [userId], references: [id])
  alerts           BudgetAlert[]
  transactions     Transaction[]

  @@index([userId, categoryId])
  @@index([userId, month, year])
}

model RecurringTransaction {
  id            String             @id @default(uuid())
  amount        Decimal            @db.Decimal(65, 4)
  frequency     RecurringFrequency
  description   String?
  startDate     DateTime
  endDate       DateTime?
  status        TransactionStatus  @default(PENDING)
  lastProcessed DateTime?
  userId        String
  categoryId    String?
  isActive      Boolean            @default(true)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  bankAccountId String
  bankAccount   BankAccount        @relation(fields: [bankAccountId], references: [id])
  category      Category?          @relation(fields: [categoryId], references: [id])
  user          User               @relation(fields: [userId], references: [id])
  transactions  Transaction[]

  @@index([userId, frequency])
}

model BudgetAlert {
  id        String       @id @default(uuid())
  budgetId  String
  alertType AlertType
  channel   AlertChannel
  sentAt    DateTime     @default(now())
  createdAt DateTime     @default(now())
  budget    Budget       @relation(fields: [budgetId], references: [id])

  @@index([budgetId, sentAt])
}

model UserPreference {
  id                    String   @id @default(uuid())
  userId                String   @unique
  currency              Currency @default(INR)
  dateFormat            String?
  theme                 String?
  defaultAccountId      String?
  defaultCategoryId     String?
  emailNotifications    Boolean  @default(true)
  budgetAlerts          Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  budgetAlertThreshold  Int      @default(80)
  telegramChatId        String?
  telegramNotifications Boolean  @default(false)
  user                  User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model User {
  id              String                 @id
  name            String
  email           String                 @unique
  emailVerified   Boolean                @default(false)
  image           String?
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @default(now()) @updatedAt
  bankAccounts    BankAccount[]
  budgets         Budget[]
  categories      Category[]
  recurringTrans  RecurringTransaction[]
  subCategories   SubCategory[]
  transactions    Transaction[]
  userPreferences UserPreference?
  accounts        Account[]
  sessions        Session[]
  investments     Investment[]
  goals           Goal[]
  assets          Asset[]

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

enum AccountType {
  BANK
  WALLET
  CASH
  CREDIT_CARD
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
  INVESTMENT
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

enum CategoryType {
  INCOME
  EXPENSE
  TRANSFER
  INVESTMENT
}

enum RecurringFrequency {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

enum UserRole {
  USER
  ADMIN
}

enum Currency {
  INR
  USD
}

enum PaymentMethod {
  UPI
  CASH
  CARD
  ONLINE
  OTHER
}

enum AlertType {
  WARNING
  EXCEEDED
}

enum AlertChannel {
  EMAIL
  TELEGRAM
  BOTH
}

model Investment {
  id            String        @id @default(uuid())
  name          String
  type          InvestmentType
  symbol        String?
  quantity      Decimal        @db.Decimal(65, 4)
  purchasePrice Decimal        @db.Decimal(65, 4)
  currentPrice  Decimal?       @db.Decimal(65, 4)
  purchaseDate  DateTime
  userId        String
  categoryId    String?
  subCategoryId String?
  description   String?
  notes         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  user          User           @relation(fields: [userId], references: [id])
  category      Category?      @relation(fields: [categoryId], references: [id])
  subCategory   SubCategory?   @relation(fields: [subCategoryId], references: [id])

  @@index([userId, type])
  @@index([userId, categoryId])
}

model Goal {
  id          String    @id @default(uuid())
  name        String
  targetAmount Decimal   @db.Decimal(65, 4)
  targetDate  DateTime
  userId      String
  description String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id])

  @@index([userId, isActive])
}

model Asset {
  id           String     @id @default(uuid())
  name         String
  type         AssetType
  currentValue Decimal    @db.Decimal(65, 4)
  purchaseValue Decimal   @db.Decimal(65, 4)
  purchaseDate DateTime
  userId       String
  description  String?
  notes        String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  user         User       @relation(fields: [userId], references: [id])

  @@index([userId, type])
}

enum InvestmentType {
  STOCKS
  BONDS
  FIXED_DEPOSIT
  NPS
  PF
  GOLD
  MUTUAL_FUNDS
  CRYPTO
  REAL_ESTATE
  OTHER
}

enum AssetType {
  PROPERTY
  VEHICLE
  JEWELRY
  ELECTRONICS
  OTHER
}
